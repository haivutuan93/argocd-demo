# GitHub Actions CI/CD Pipeline
# Workflow nÃ y sáº½:
# 1. Build Docker image
# 2. Push lÃªn Docker Hub
# 3. Update image tag trong Helm values
# 4. ArgoCD sáº½ tá»± Ä‘á»™ng detect vÃ  deploy

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/argocd-demo
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Print image info
        run: |
          echo "âœ… Image pushed successfully!"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}"

  update-helm:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Helm values
        run: |
          VERSION=${{ needs.build-and-push.outputs.version }}
          
          # Update image tag in values.yaml
          sed -i "s|tag: \".*\"|tag: \"$VERSION\"|g" helm/argocd-demo/values.yaml
          
          # Update image repository to Docker Hub
          sed -i "s|repository: .*|repository: ${{ secrets.DOCKER_USERNAME }}/argocd-demo|g" helm/argocd-demo/values.yaml
          
          # Update app version
          sed -i "s|version: \".*\"|version: \"$VERSION\"|g" helm/argocd-demo/values.yaml
          
          echo "Updated values.yaml with version: $VERSION"
          cat helm/argocd-demo/values.yaml | head -20
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add helm/argocd-demo/values.yaml
          git commit -m "ðŸš€ Update image to ${{ needs.build-and-push.outputs.version }}" || echo "No changes to commit"
          git push
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ CI/CD Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ secrets.DOCKER_USERNAME }}/argocd-demo:${{ needs.build-and-push.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Pushed to Docker Hub |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync the new version!" >> $GITHUB_STEP_SUMMARY

